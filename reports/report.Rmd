---
output:
  html_document
---

## nextHIV Report {.tabset}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r loadlibraries}
suppressPackageStartupMessages(library(rethinker))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(cowplot))
suppressPackageStartupMessages(library(plotly))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(xtable))
```

```{r setglobals}
host <- "localhost"
port <- 28015
authKey <- NULL
v <- "V0_4"
db <- "nexthiv"
pid <- "CFAR_PID"
```

```{r definefunctions}
get_table <- function(db,tbl,maxResults=10000,host="localhost",port=28015,authKey=NULL,v="V0_4"){
  connection <- openConnection(host = host, port = port, authKey = authKey, v = v)
  r() -> query
  query$db(db)
  query$table(tbl)
  cursor <- query$run(connection)
  l <- cursorToList(cursor,maxResults=maxResults)
  df <- do.call(rbind, lapply(l, data.frame, stringsAsFactors=FALSE))
  close(connection)
  return(df)
}
```

```{r loadtables}
demographics <- get_table(db,"demographics")
sequences <- get_table(db,"sequences")
clustering <- get_table(db,"clustering")
```

### Summary

Date of report: `r Sys.Date()`

No. of individuals: `r length(unique(sequences$CFAR_PID))`

### Demographics


```{r}
p <- ggplot(demographics,aes(x=as.double(YEAR_OF_COHORT_ENTRY)))+geom_bar()+xlab("Year of cohort entry")+ylab("Count")
ggplotly(p)
```


```{r}
p <- ggplot(demographics,aes(x=as.double(AGE_AT_ENROLLMENT)))+geom_histogram(binwidth=1)+xlab("Age at cohort entry")+ylab("Count")
ggplotly(p)
```


```{r}
p <- ggplot(demographics,aes(x=SEX))+geom_bar()+xlab("Gender")+ylab("Count")+scale_x_discrete(labels=c("Female","Male"))
ggplotly(p)
```

```{r}
p <- ggplot(demographics,aes(x=RISK1))+geom_bar()+xlab("Risk behavior")+ylab("Count")
ggplotly(p)
```


```{r}
p <- ggplot(demographics,aes(x=RACE))+geom_bar()+xlab("Race")+ylab("Count")
ggplotly(p)
```

### Sequences


```{r}
df <- as.data.frame.table(table(table(sequences$CFAR_PID)))
names(df) <- c("Number","Count")
p <- ggplot(df,aes(x=Number,y=Count))+geom_bar(stat="identity")+xlab("Sequences per individual")+ylab("Count")
ggplotly(p)
```

<br>

```{r}
datatable(df)
```


### Clustering


```{r}
#redo with clustering
seqclus <- merge(sequences,clustering[,1:3],by.x="id",by.y="SEQNAME")
o <- order(seqclus$CFAR_PID,as.double(seqclus$AGE_AT_SEQUENCE))
seqclus <- seqclus[o,]
idx <- !duplicated(seqclus$CFAR_PID)
```


```{r}
p <- ggplot(clustering,aes(x=as.double(MINDST)))+geom_histogram(binwidth=0.001)+xlab("Minimum genetic distance")+ylab("Count")
ggplotly(p)
```



