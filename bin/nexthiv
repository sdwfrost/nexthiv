#!/usr/bin/env python3

import argparse
import yaml
import nexthiv

parser = argparse.ArgumentParser()
subparsers = parser.add_subparsers(title='subcommands',description='valid subcommands',help='subcommand help',dest='subparser_name')

init_parser=subparsers.add_parser('init',help='Initialise database')
init_parser.add_argument('-c','--config',type=argparse.FileType('r'),required=True,help='YAML configuration file')

import_parser=subparsers.add_parser('import',help='Import CSV')
import_parser.add_argument('-c','--config',type=argparse.FileType('r'),required=True,help='YAML configuration file')
import_parser.add_argument('-i','--input',type=argparse.FileType('r'),required=True,help='TSV file')
import_parser.add_argument('-d','--destination',required=True,help='Destination table')

align_parser=subparsers.add_parser('align',help='Align sequences')
align_parser.add_argument('-c','--config',type=argparse.FileType('r'),required=True,help='YAML configuration file')

distance_parser=subparsers.add_parser('distance',help='Calculate distances')
distance_parser.add_argument('-c','--config',type=argparse.FileType('r'),required=True,help='YAML configuration file')

cluster_parser=subparsers.add_parser('cluster',help='CLuster sequences')
cluster_parser.add_argument('-c','--config',type=argparse.FileType('r'),required=True,help='YAML configuration file')


arguments=parser.parse_args()
action=arguments.subparser_name

# Init
if action=='init':
  config_file=arguments.config
  config=yaml.load(config_file)
  nexthiv.db.db_setup(config)

# Import
if action=='import':
  config_file=arguments.config
  config=yaml.load(config_file)
  data=nexthiv.db.tsv2json(arguments.input)
  tbl=arguments.destination
  nexthiv.db.db_insert(config,tbl,data,chunksize=100000)

# Align
if action=='align':
  config_file=arguments.config
  config=yaml.load(config_file)
  aln=nexthiv.align.align_seqs(config)
  aln=nexthiv.align.trim_alignment(config,aln)
  nexthiv.db.insert_seqs(config,aln,config['sequence']['processed_table'],config['sequence']['processed_name'])

# Resistance

# Distances
if action=='distance':
  config_file=arguments.config
  config=yaml.load(config_file)
  nexthiv.cluster.insert_distances(config)

# Clustering
if action=='cluster':
  config_file=arguments.config
  config=yaml.load(config_file)
  nexthiv.cluster.insert_clustering(config)
